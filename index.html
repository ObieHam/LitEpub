<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebToEpub PWA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #6200ea;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
            resize: vertical;
            min-height: 200px;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }
        
        textarea:focus {
            outline: none;
            border-color: #6200ea;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #6200ea;
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: #6200ea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #5000d0;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        #status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        
        #status.show {
            display: block;
        }
        
        #status.loading {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #90caf9;
        }
        
        #status.success {
            background: #e8f5e9;
            color: #388e3c;
            border: 1px solid #81c784;
        }
        
        #status.error {
            background: #ffebee;
            color: #d32f2f;
            border: 1px solid #ef5350;
        }
        
        .progress {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .hint {
            font-size: 12px;
            color: #999;
            margin-top: -10px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebToEpub</h1>
        <p>Download Literotica stories as EPUB. Add multiple chapter links (one per line) to combine them into a single book.</p>
        
        <label for="urlInput">Chapter URLs (one per line)</label>
        <textarea id="urlInput" placeholder="https://www.literotica.com/s/chapter-01
https://www.literotica.com/s/chapter-02
https://www.literotica.com/s/chapter-03"></textarea>
        <p class="hint">Each line should contain one chapter URL</p>
        
        <label for="bookTitle">Book Title (optional)</label>
        <input type="text" id="bookTitle" placeholder="Leave empty to use first chapter's title">
        
        <button id="convertBtn">Download EPUB</button>
        
        <div id="status"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <script>
        const urlInput = document.getElementById('urlInput');
        const bookTitleInput = document.getElementById('bookTitle');
        const convertBtn = document.getElementById('convertBtn');
        const status = document.getElementById('status');

        function showStatus(message, type) {
            status.textContent = message;
            status.className = `show ${type}`;
        }

        function sanitizeFilename(name) {
            return name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        }

        async function fetchChapter(url) {
            const response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
            if (!response.ok) throw new Error(`Failed to fetch: ${url}`);
            
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            const title = doc.querySelector('h1')?.textContent?.trim() || 'Untitled';
            const author = doc.querySelector('.y_eU')?.textContent?.trim() || 'Unknown';
            
            let content = '';
            const contentDiv = doc.querySelector('.aa_ht');
            if (contentDiv) {
                const paragraphs = contentDiv.querySelectorAll('p');
                paragraphs.forEach(p => {
                    content += `<p>${p.innerHTML}</p>\n`;
                });
            }
            
            return { title, author, content };
        }

        function generateEpub(chapters, bookTitle, author) {
            const zip = new JSZip();
            
            // mimetype (must be first, uncompressed)
            zip.file('mimetype', 'application/epub+zip', {compression: 'STORE'});
            
            // META-INF/container.xml
            zip.file('META-INF/container.xml', `<?xml version="1.0"?>
<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
  <rootfiles>
    <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>
  </rootfiles>
</container>`);
            
            // Generate chapter files
            let manifestItems = '';
            let spineItems = '';
            let tocItems = '';
            
            chapters.forEach((chapter, index) => {
                const chapterId = `chapter${index + 1}`;
                const filename = `${chapterId}.xhtml`;
                
                // Chapter XHTML
                zip.file(`OEBPS/${filename}`, `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>${chapter.title}</title>
    <link rel="stylesheet" type="text/css" href="style.css"/>
</head>
<body>
    <h1>${chapter.title}</h1>
    ${chapter.content}
</body>
</html>`);
                
                manifestItems += `    <item id="${chapterId}" href="${filename}" media-type="application/xhtml+xml"/>\n`;
                spineItems += `    <itemref idref="${chapterId}"/>\n`;
                tocItems += `    <navPoint id="navPoint-${index + 1}" playOrder="${index + 1}">
      <navLabel><text>${chapter.title}</text></navLabel>
      <content src="${filename}"/>
    </navPoint>\n`;
            });
            
            // content.opf
            zip.file('OEBPS/content.opf', `<?xml version="1.0" encoding="UTF-8"?>
<package xmlns="http://www.idpf.org/2007/opf" unique-identifier="BookId" version="2.0">
  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:opf="http://www.idpf.org/2007/opf">
    <dc:title>${bookTitle}</dc:title>
    <dc:creator>${author}</dc:creator>
    <dc:language>en</dc:language>
    <dc:identifier id="BookId">urn:uuid:${Date.now()}</dc:identifier>
  </metadata>
  <manifest>
${manifestItems}    <item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
    <item id="style" href="style.css" media-type="text/css"/>
  </manifest>
  <spine toc="ncx">
${spineItems}  </spine>
</package>`);
            
            // toc.ncx
            zip.file('OEBPS/toc.ncx', `<?xml version="1.0" encoding="UTF-8"?>
<ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">
  <head>
    <meta name="dtb:uid" content="urn:uuid:${Date.now()}"/>
    <meta name="dtb:depth" content="1"/>
    <meta name="dtb:totalPageCount" content="0"/>
    <meta name="dtb:maxPageNumber" content="0"/>
  </head>
  <docTitle><text>${bookTitle}</text></docTitle>
  <navMap>
${tocItems}  </navMap>
</ncx>`);
            
            // style.css
            zip.file('OEBPS/style.css', `body {
    font-family: Georgia, serif;
    line-height: 1.6;
    margin: 2em;
}
h1 {
    text-align: center;
    margin-bottom: 2em;
}
p {
    text-indent: 1.5em;
    margin: 0;
}
p:first-of-type {
    text-indent: 0;
}`);
            
            return zip;
        }

        convertBtn.addEventListener('click', async () => {
            const urls = urlInput.value.trim().split('\n').filter(line => line.trim());
            
            if (urls.length === 0) {
                showStatus('Please enter at least one URL', 'error');
                return;
            }
            
            // Validate URLs
            const invalidUrls = urls.filter(url => !url.includes('literotica.com'));
            if (invalidUrls.length > 0) {
                showStatus('All URLs must be from literotica.com', 'error');
                return;
            }
            
            convertBtn.disabled = true;
            showStatus('Fetching chapters...', 'loading');
            
            try {
                const chapters = [];
                let firstAuthor = '';
                
                for (let i = 0; i < urls.length; i++) {
                    showStatus(`Fetching chapter ${i + 1} of ${urls.length}...`, 'loading');
                    const chapter = await fetchChapter(urls[i].trim());
                    chapters.push(chapter);
                    
                    if (i === 0) {
                        firstAuthor = chapter.author;
                    }
                }
                
                showStatus('Generating EPUB...', 'loading');
                
                const bookTitle = bookTitleInput.value.trim() || chapters[0].title;
                const zip = generateEpub(chapters, bookTitle, firstAuthor);
                
                showStatus('Creating download...', 'loading');
                
                const blob = await zip.generateAsync({type: 'blob'});
                saveAs(blob, `${sanitizeFilename(bookTitle)}.epub`);
                
                showStatus(`Successfully downloaded ${chapters.length} chapter(s)!`, 'success');
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                console.error(error);
            } finally {
                convertBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
